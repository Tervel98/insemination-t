<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Осеменяване</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      background-color: #f5f5f5;
    }
    .hidden { display: none; }
    .login-box {
      max-width: 300px;
      margin: 50px auto;
      padding: 2rem;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .login-box input, .login-box button {
      width: 100%;
      margin-bottom: 10px;
      padding: 0.5rem;
    }
    .section { margin-top: 2rem; }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    .delete-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Форма за вход -->
  <div id="loginSection" class="login-box">
    <h2>Вход</h2>
    <input type="text" id="username" placeholder="Потребителско име" />
    <input type="password" id="password" placeholder="Парола" />
    <button onclick="checkLogin()">Влез</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- Основна част на сайта -->
  <div id="mainContent" class="hidden">

    <!-- Форма за добавяне на нов запис -->
    <div class="section">
      <h3>Добавяне на осеменяване</h3>
      <form id="inseminationForm">
        <label>Осеменител:
          <select id="worker" required>
            <option value="ivan">ivan</option>
            <option value="vasil">vasil</option>
            <option value="krustyo">krustyo</option>
            <option value="stela">stela</option>
          </select>
        </label><br /><br />
        <label>Номер на крава:
          <input type="text" id="cowNumber" required />
        </label><br /><br />
        <label>Вид осеменяване:
          <input type="text" id="type" required />
        </label><br /><br />
        <label>Дата:
          <input type="date" id="date" required />
        </label><br /><br />
        <button type="submit">Добави</button>
      </form>
    </div>

    <!-- Търсене по номер -->
    <div class="section">
      <h3>Търсене по номер на крава</h3>
      <form id="searchForm">
        <input type="text" id="searchCow" placeholder="Въведи номер на крава" required />
        <button type="submit">Търси</button>
      </form>
      <div id="searchResult" style="margin-top:1rem; display:none;">
        <p id="foundInfo"></p>
        <div id="pregnancySection" style="display:none;">
          <label>Резултат тест бременност:
            <select id="pregnancyResult">
              <option value="Няма данни">Няма данни</option>
              <option value="Положителен">Положителен</option>
              <option value="Отрицателен">Отрицателен</option>
            </select>
          </label>
          <button id="updateTestBtn">Обнови резултат</button>
        </div>
      </div>
    </div>

    <!-- Таблици с данни по осеменители -->
    <div class="section" id="tablesSection">
      <h3>Данни по осеменители</h3>
      <div id="workerTablesContainer"></div>
    </div>

    <!-- Графика -->
    <div class="section">
      <h3>Графика на успеваемост</h3>
      <canvas id="successChart"></canvas>
    </div>

    <!-- Секция за редакция -->
    <div class="section">
      <h3>Редактиране на записи</h3>
      <label>Избери запис за редакция:
        <select id="recordSelect">
          <option value="">-- Избери запис --</option>
        </select>
      </label>
      <div id="editFormContainer" style="margin-top: 1rem; display:none;">
        <form id="editRecordForm">
          <label>Осеменител:
            <select id="editWorker" required>
              <option value="ivan">ivan</option>
              <option value="vasil">vasil</option>
              <option value="krustyo">krustyo</option>
              <option value="stela">stela</option>
            </select>
          </label><br /><br />
          <label>Номер на крава:
            <input type="text" id="editCowNumber" required />
          </label><br /><br />
          <label>Вид осеменяване:
            <input type="text" id="editType" required />
          </label><br /><br />
          <label>Дата:
            <input type="date" id="editDate" required />
          </label><br /><br />
          <label>Резултат:
            <select id="editResult">
              <option value="Няма данни">Няма данни</option>
              <option value="Положителен">Положителен</option>
              <option value="Отрицателен">Отрицателен</option>
            </select>
          </label><br /><br />
          <button type="submit">Запази промените</button>
        </form>
      </div>
    </div>

  </div>

  <script>
    const correctUsername = "admin";
    const correctPassword = "9802";

    function checkLogin() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      const errorEl = document.getElementById("loginError");

      if (username === correctUsername && password === correctPassword) {
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("mainContent").classList.remove("hidden");
        initApp();
      } else {
        errorEl.textContent = "Грешно потребителско име или парола!";
      }
    }

    function initApp() {
      const firebaseConfig = {
        apiKey: "AIzaSyC-LpBbZPD_FDcAall27oiloU-XcMVMUd8",
        authDomain: "insemination-tracker-46146.firebaseapp.com",
        projectId: "insemination-tracker-46146",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      const data = [];
      let chart;

      const workerTablesContainer = document.getElementById("workerTablesContainer");
      const recordSelect = document.getElementById("recordSelect");
      const editFormContainer = document.getElementById("editFormContainer");
      const editRecordForm = document.getElementById("editRecordForm");

      // Създаваме таблици по осеменители
      const workers = ['ivan', 'vasil', 'krustyo', 'stela'];

      function createTables() {
        workerTablesContainer.innerHTML = "";
        workers.forEach(worker => {
          const section = document.createElement("section");
          section.innerHTML = `
            <h4>${worker}</h4>
            <table id="table-${worker}">
              <thead>
                <tr>
                  <th>Номер крава</th>
                  <th>Вид</th>
                  <th>Дата</th>
                  <th>Резултат</th>
                  <th>Действие</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <p id="rate-${worker}"></p>
          `;
          workerTablesContainer.appendChild(section);
        });
      }

      function updateTables() {
        workers.forEach(worker => {
          const tableBody = document.querySelector(`#table-${worker} tbody`);
          const rateEl = document.getElementById(`rate-${worker}`);
          tableBody.innerHTML = "";

          const filtered = data.filter(r => r.worker === worker);
          let pos = 0, neg = 0;

          filtered.forEach(record => {
            const row = document.createElement("tr");

            row.innerHTML = `
              <td>${record.cowNumber}</td>
              <td>${record.type}</td>
              <td>${record.date}</td>
              <td>${record.result}</td>
              <td></td>
            `;

            const delBtn = document.createElement("button");
            delBtn.textContent = "Изтрий";
            delBtn.className = "delete-btn";
            delBtn.onclick = async () => {
              const pass = prompt("Въведи парола за изтриване:");
              if (pass !== correctPassword) {
                alert("Грешна парола!");
                return;
              }
              await db.collection("inseminations").doc(record.id).delete();
              const idx = data.findIndex(d => d.id === record.id);
              if (idx > -1) data.splice(idx, 1);
              updateTables();
              populateRecordSelect();
              updateChart();
            };

            row.querySelector("td:last-child").appendChild(delBtn);
            tableBody.appendChild(row);

            if (record.result === "Положителен") pos++;
            else if (record.result === "Отрицателен") neg++;
          });

          const total = pos + neg;
          const successRate = total > 0 ? ((pos / total) * 100).toFixed(1) : 0;
          rateEl.textContent = `Успеваемост: ${successRate}%`;
        });
      }

      // Графика
      function updateChart() {
        const labels = [];
        const success = [];
        const fail = [];

        workers.forEach(worker => {
          const filtered = data.filter(r => r.worker === worker);
          let pos = 0, neg = 0;
          filtered.forEach(record => {
            if (record.result === "Положителен") pos++;
            else if (record.result === "Отрицателен") neg++;
          });
          const total = pos + neg;
          const successRate = total > 0 ? ((pos / total) * 100) : 0;
          labels.push(worker);
          success.push(successRate.toFixed(1));
          fail.push((100 - successRate).toFixed(1));
        });

        if (chart) chart.destroy();
        chart = new Chart(document.getElementById("successChart"), {
          type: "bar",
          data: {
            labels,
            datasets: [
              { label: "Успеваемост (%)", backgroundColor: "#4caf50", data: success },
              { label: "Неуспеваемост (%)", backgroundColor: "#e74c3c", data: fail }
            ]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true, max: 100 } }
          }
        });
      }

      // Зареждане на данните от Firebase
      async function loadData() {
        data.length = 0;
        const snapshot = await db.collection("inseminations").get();
        snapshot.forEach(doc => data .push({ id: doc.id, ...doc.data() }));
updateTables();
populateRecordSelect();
updateChart();
}  // Добавяне на нов запис
  document.getElementById("inseminationForm").onsubmit = async (e) => {
    e.preventDefault();
    const worker = document.getElementById("worker").value.trim().toLowerCase();
    const cowNumber = document.getElementById("cowNumber").value.trim();
    const type = document.getElementById("type").value.trim();
    const date = document.getElementById("date").value;

    if (!worker || !cowNumber || !type || !date) {
      alert("Моля, попълнете всички полета!");
      return;
    }

    // Проверка за дублиране на номер
    if (data.some(r => r.cowNumber === cowNumber)) {
      alert("Вече съществува запис с този номер на крава!");
      return;
    }

    await db.collection("inseminations").add({
      worker,
      cowNumber,
      type,
      date,
      result: "Няма данни"
    });

    alert("Добавено успешно!");
    document.getElementById("inseminationForm").reset();
    loadData();
  };

  // Търсене по номер и обновяване на резултат тест
  const searchForm = document.getElementById("searchForm");
  const searchResult = document.getElementById("searchResult");
  const foundInfo = document.getElementById("foundInfo");
  const pregnancySection = document.getElementById("pregnancySection");
  const pregnancyResult = document.getElementById("pregnancyResult");
  const updateTestBtn = document.getElementById("updateTestBtn");
  let currentSearchRecordId = null;

  searchForm.onsubmit = (e) => {
    e.preventDefault();
    const searchVal = document.getElementById("searchCow").value.trim();
    if (!searchVal) return;

    const found = data.find(r => r.cowNumber === searchVal);
    if (!found) {
      foundInfo.textContent = "Няма намерен запис.";
      pregnancySection.style.display = "none";
      searchResult.style.display = "block";
      currentSearchRecordId = null;
      return;
    }

    foundInfo.textContent = `Осеменител: ${found.worker}, Дата: ${found.date}, Вид: ${found.type}, Резултат: ${found.result}`;
    pregnancyResult.value = found.result || "Няма данни";
    pregnancySection.style.display = "block";
    searchResult.style.display = "block";
    currentSearchRecordId = found.id;
  };

  updateTestBtn.onclick = async () => {
    if (!currentSearchRecordId) return alert("Няма избран запис за обновяване.");
    const newResult = pregnancyResult.value;

    const pass = prompt("Въведи парола за обновяване:");
    if (pass !== correctPassword) {
      alert("Грешна парола!");
      return;
    }

    await db.collection("inseminations").doc(currentSearchRecordId).update({
      result: newResult
    });

    alert("Резултатът е обновен.");
    loadData();
    searchResult.style.display = "none";
  };

  // --- Редакция на записи ---

  function populateRecordSelect() {
    recordSelect.innerHTML = '<option value="">-- Избери запис --</option>';
    data.forEach(rec => {
      const option = document.createElement("option");
      option.value = rec.id;
      option.textContent = `${rec.cowNumber} (${rec.worker}) - ${rec.date}`;
      recordSelect.appendChild(option);
    });
    editFormContainer.style.display = "none";
  }

  recordSelect.onchange = () => {
    const selectedId = recordSelect.value;
    if (!selectedId) {
      editFormContainer.style.display = "none";
      return;
    }
    const rec = data.find(r => r.id === selectedId);
    if (!rec) return;

    document.getElementById("editWorker").value = rec.worker;
    document.getElementById("editCowNumber").value = rec.cowNumber;
    document.getElementById("editType").value = rec.type;
    document.getElementById("editDate").value = rec.date;
    document.getElementById("editResult").value = rec.result || "Няма данни";

    editFormContainer.style.display = "block";
  };

  editRecordForm.onsubmit = async (e) => {
    e.preventDefault();
    const selectedId = recordSelect.value;
    if (!selectedId) return alert("Избери запис за редакция!");

    const newWorker = document.getElementById("editWorker").value.trim().toLowerCase();
    const newCowNumber = document.getElementById("editCowNumber").value.trim();
    const newType = document.getElementById("editType").value.trim();
    const newDate = document.getElementById("editDate").value;
    const newResult = document.getElementById("editResult").value;

    // Проверка за дублирани номера (без да броим текущия запис)
    const duplicate = data.some(r => r.cowNumber === newCowNumber && r.id !== selectedId);
    if (duplicate) {
      alert("Вече съществува друг запис с този номер на крава!");
      return;
    }

    const pass = prompt("Въведи парола за редакция:");
    if (pass !== correctPassword) {
      alert("Грешна парола!");
      return;
    }

    await db.collection("inseminations").doc(selectedId).update({
      worker: newWorker,
      cowNumber: newCowNumber,
      type: newType,
      date: newDate,
      result: newResult
    });

    // Актуализиране локално
    const idx = data.findIndex(r => r.id === selectedId);
    if (idx > -1) {
      data[idx] = { id: selectedId, worker: newWorker, cowNumber: newCowNumber, type: newType, date: newDate, result: newResult };
    }

    alert("Записът е обновен успешно.");
    populateRecordSelect();
    updateTables();
    updateChart();
    editFormContainer.style.display = "none";
    recordSelect.value = "";
  };

  // Зареждаме данните при стартиране
  loadData();
}
