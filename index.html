<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>Осеменявания</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .form-section {
      background: #ffffff;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
      border-radius: 10px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 20px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .inseminator {
      background: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #e0e0e0;
    }
    .success-rate {
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    #chartContainer {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    #editPasswordInput {
      display: none;
      margin-bottom: 10px;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    #editError {
      color: red;
      display: none;
      margin-bottom: 10px;
    }
    #editSuccess {
      color: green;
      display: none;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>График на осеменяванията</h1>
  
  <div class="form-section">
    <h2>Добави осеменяване</h2>
    <form id="inseminationForm">
      <label for="worker">Осеменител:</label>
      <select id="worker" required>
        <option value="">Избери</option>
        <option value="ivan">Иван</option>
        <option value="vasil">Васил</option>
        <option value="krustyo">Кръстьо</option>
        <option value="stela">Стела</option>
      </select>
      <label for="cowNumber">Номер на кравата:</label>
      <input type="text" id="cowNumber" required />
      <label for="type">Вид осеменяване:</label>
      <input type="text" id="type" required />
      <label for="date">Дата на осеменяване:</label>
      <input type="date" id="date" required />
      <button type="submit">Добави</button>
    </form>
  </div>

  <div class="form-section">
    <h2>Търси крава и добави тест за бременност</h2>
    <form id="searchForm">
      <label for="searchCow">Номер на кравата:</label>
      <input type="text" id="searchCow" required />
      <button type="submit">Търси</button>
    </form>
    <div id="searchResult" style="margin-top: 20px; display: none;">
      <p><strong>Намерена крава:</strong></p>
      <p id="foundInfo"></p>
      <div id="pregnancySection" style="display: none;">
        <label for="pregnancyResult">Тест за бременност:</label>
        <select id="pregnancyResult">
          <option value="Няма данни">Няма данни</option>
          <option value="Положителен">Положителен</option>
          <option value="Отрицателен">Отрицателен</option>
        </select>
        <input type="password" id="editPasswordInput" placeholder="Въведи парола за редакция" />
        <div id="editError">Грешна парола!</div>
        <div id="editSuccess">Успешна редакция!</div>
        <button id="updateTestBtn">Запиши резултат</button>
      </div>
    </div>
  </div>

  <div id="chartContainer">
    <h2>Графика на успеваемост и неуспех</h2>
    <canvas id="successChart" width="400" height="200"></canvas>
  </div>

  <div class="inseminator">
    <h2>Иван</h2>
    <div class="success-rate" id="rate-ivan"></div>
    <table id="table-ivan">
      <tr>
        <th>Номер на кравата</th>
        <th>Вид осеменяване</th>
        <th>Дата</th>
        <th>Тест за бременност</th>
      </tr>
    </table>
  </div>
  <div class="inseminator">
    <h2>Васил</h2>
    <div class="success-rate" id="rate-vasil"></div>
    <table id="table-vasil">
      <tr>
        <th>Номер на кравата</th>
        <th>Вид осеменяване</th>
        <th>Дата</th>
        <th>Тест за бременност</th>
      </tr>
    </table>
  </div>
  <div class="inseminator">
    <h2>Кръстьо</h2>
    <div class="success-rate" id="rate-krustyo"></div>
    <table id="table-krustyo">
      <tr>
        <th>Номер на кравата</th>
        <th>Вид осеменяване</th>
        <th>Дата</th>
        <th>Тест за бременност</th>
      </tr>
    </table>
  </div>
  <div class="inseminator">
    <h2>Стела</h2>
    <div class="success-rate" id="rate-stela"></div>
    <table id="table-stela">
      <tr>
        <th>Номер на кравата</th>
        <th>Вид осеменяване</th>
        <th>Дата</th>
        <th>Тест за бременност</th>
      </tr>
    </table>
  </div>
<script>
window.onload = function () {
  const EDIT_PASSWORD = "9802";

  const firebaseConfig = {
    apiKey: "AIzaSyC-LpBbZPD_FDcAall27oiloU-XcMVMUd8",
    authDomain: "insemination-tracker-46146.firebaseapp.com",
    projectId: "insemination-tracker-46146",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let data = [];
  let currentDocId = null;
  let chart;

  async function loadData() {
    data = [];
    const snapshot = await db.collection("inseminations").get();
    snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
    updateTables();
  }

  document.getElementById("inseminationForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const record = {
      worker: document.getElementById("worker").value,
      cowNumber: document.getElementById("cowNumber").value.trim(),
      type: document.getElementById("type").value.trim(),
      date: document.getElementById("date").value,
  pregnancyTest: "Няма данни",
};
if (!record.worker || !record.cowNumber || !record.type || !record.date) {
  alert("Моля, попълнете всички полета.");
  return;
}
try {
  await db.collection("inseminations").add(record);
  alert("Записано успешно!");
  this.reset();
  await loadData();
} catch {
  alert("Грешка при добавяне.");
}

// Зареждане на данни при стартиране
loadData();

// Обновяване на графика
function updateChart() {
const workers = ["ivan", "vasil", "krustyo", "stela"];
const successRates = workers.map(w => {
const records = data.filter(d => d.worker === w && d.pregnancyTest !== "Няма данни");
const successCount = records.filter(r => r.pregnancyTest === "Положителен").length;
const failCount = records.filter(r => r.pregnancyTest === "Отрицателен").length;
const total = successCount + failCount;
return total > 0 ? ((successCount / total) * 100).toFixed(2) : 0;
});const failRates = workers.map(w => {
  const records = data.filter(d => d.worker === w && d.pregnancyTest !== "Няма данни");
  const failCount = records.filter(r => r.pregnancyTest === "Отрицателен").length;
  const total = records.filter(r => r.pregnancyTest !== "Няма данни").length;
  return total > 0 ? ((failCount / total) * 100).toFixed(2) : 0;
});

if (chart) chart.destroy();

const ctx = document.getElementById('successChart').getContext('2d');
chart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: ['Иван', 'Васил', 'Кръстьо', 'Стела'],
    datasets: [
      {
        label: 'Успеваемост (%)',
        backgroundColor: 'rgba(75, 192, 192, 0.7)',
        data: successRates
      },
      {
        label: 'Неуспеваемост (%)',
        backgroundColor: 'rgba(255, 99, 132, 0.7)',
        data: failRates
      }
    ]
  },
  options: {
    scales: {
      y: {
        beginAtZero: true,
        max: 100
      }
    }
  }
});
}
  // Елементи за търсене и редакция
  const searchForm = document.getElementById("searchForm");
  const searchCow = document.getElementById("searchCow");
  const searchResult = document.getElementById("searchResult");
  const foundInfo = document.getElementById("foundInfo");
  const pregnancySection = document.getElementById("pregnancySection");
  const pregnancyResult = document.getElementById("pregnancyResult");
  const updateTestBtn = document.getElementById("updateTestBtn");
  const editPasswordInput = document.getElementById("editPasswordInput");
  const editError = document.getElementById("editError");
  const editSuccess = document.getElementById("editSuccess");

  searchForm.addEventListener("submit", (e) => {
    e.preventDefault();
    editError.style.display = "none";
    editSuccess.style.display = "none";
    const cow = searchCow.value.trim();
    currentDocId = null;
    pregnancySection.style.display = "none";
    foundInfo.textContent = "";

    if (!cow) return alert("Въведи номер на кравата.");

    const record = data.find(d => d.cowNumber === cow);
    if (!record) {
      foundInfo.textContent = "Няма намерена крава с този номер.";
      searchResult.style.display = "block";
      return;
    }
    currentDocId = record.id;
    foundInfo.textContent = `Крава: ${record.cowNumber}, Осеменител: ${record.worker}, Дата: ${record.date}, Тест: ${record.pregnancyTest || "Няма данни"}`;
    pregnancySection.style.display = "block";
    pregnancyResult.value = record.pregnancyTest || "Няма данни";
    editPasswordInput.style.display = "none";
    updateTestBtn.textContent = "Запиши резултат";

    searchResult.style.display = "block";
  });

  // Логика за запис и редакция с парола
  updateTestBtn.onclick = async () => {
    editError.style.display = "none";
    editSuccess.style.display = "none";

    if (!currentDocId) {
      alert("Няма избрана крава.");
      return;
    }

    const newTest = pregnancyResult.value;
    const currentRecord = data.find(d => d.id === currentDocId);

    if (currentRecord.pregnancyTest === "Няма данни" || currentRecord.pregnancyTest === undefined) {
      // Първоначален запис - без парола
      try {
        await db.collection("inseminations").doc(currentDocId).update({ pregnancyTest: newTest });
        editSuccess.style.display = "block";
        await loadData();
      } catch {
        alert("Грешка при запис.");
      }
    } else {
      // Опит за промяна - изисква парола
      if (editPasswordInput.style.display === "none") {
        editPasswordInput.style.display = "block";
        updateTestBtn.textContent = "Потвърди с парола";
        editPasswordInput.value = "";
        return;
      }
      // Проверка на паролата
      if (editPasswordInput.value !== EDIT_PASSWORD) {
        editError.style.display = "block";
        return;
      }
      // Паролата е вярна - записваме
      try {
        await db.collection("inseminations").doc(currentDocId).update({ pregnancyTest: newTest });
        editSuccess.style.display = "block";
        editError.style.display = "none";
        editPasswordInput.style.display = "none";
        updateTestBtn.textContent = "Запиши резултат";
        await loadData();
      } catch {
        alert("Грешка при запис.");
      }
    }
  };
